<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hanzi Flash ‚Äî Clean Mobile + Corner Stats</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0f">
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
  }
  </script>

  <style>
    :root{--bg:#0b0b0f;--fg:#f3f3f5;--muted:#9aa0a6;--accent:#4f8cff;--good:#2ecc71;--bad:#ff5c5c;--card:#15151b;--card2:#1d1d26}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    .wrap{max-width:680px;margin:0 auto;padding:env(safe-area-inset-top) 16px calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;height:100%}

    header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;gap:8px}
    h1{font-size:16px;margin:0;color:var(--muted)}
    .stats{font-size:12px;color:var(--muted)}

    .card{flex:1;display:flex;align-items:center;justify-content:center;perspective:1000px;user-select:none;-webkit-user-select:none;touch-action:manipulation;margin:10px 0 14px}
    .face{
      width:100%;height:100%;max-height:62vh;border-radius:16px;
      background:linear-gradient(175deg,var(--card),var(--card2));
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;padding:24px;position:relative;
      transform-style:preserve-3d;transition:transform .38s ease;
    }
    .face.flipped{transform:rotateY(180deg)}
    .front,.back{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;backface-visibility:hidden;-webkit-backface-visibility:hidden;padding:24px}
    .back{transform:rotateY(180deg)}
    .hanzi{font-size:16vw;line-height:1;font-weight:600}
    @media (min-width:600px){.hanzi{font-size:96px}}
    .pinyin{font-size:6vw;opacity:.9}
    .meaning{font-size:5vw;color:var(--muted)}
    @media (min-width:600px){.pinyin{font-size:28px}.meaning{font-size:22px}}
    .pill{font-size:11px;color:#cbd1d8;background:#0c0e15;border:1px solid #2a2a33;border-radius:999px;padding:6px 10px}

    /* Controls (desktop) */
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{flex:1;border:none;border-radius:14px;padding:14px 16px;font-size:16px;font-weight:600;cursor:pointer}
    .again{background:rgba(255,92,92,.12);color:var(--bad);border:1px solid rgba(255,92,92,.3)}
    .flip{background:transparent;border:1px dashed #3a3a46;color:var(--muted);flex:0 0 auto}
    .good{background:rgba(46,204,113,.12);color:var(--good);border:1px solid rgba(46,204,113,.3)}
    .sound{background:transparent;border:1px solid #2a2a33;color:var(--fg);flex:0 0 auto}
    .tool{background:transparent;border:1px solid #2a2a33;color:var(--fg);flex:0 0 auto}
    .deck-tools{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .link{font-size:12px;color:var(--accent);background:none;border:none;padding:0;text-decoration:underline;cursor:pointer}

    dialog{border:none;border-radius:14px;background:#11131a;color:var(--fg);max-width:680px;width:92vw;padding:0}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .sheet{padding:16px;display:flex;flex-direction:column;gap:12px}
    textarea{width:100%;min-height:40vh;border-radius:10px;background:#0c0e15;color:var(--fg);border:1px solid #2a2a33;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .row{display:flex;gap:10px;justify-content:space-between;align-items:center}
    .small{font-size:12px;color:var(--muted)}
    .right{display:flex;gap:10px;align-items:center}

    /* ---- Mobile √©pur√© : uniquement la carte visible ---- */
    @media (max-width:640px){
      header, .controls, .deck-tools { display:none !important; }
      .wrap{ padding-top: env(safe-area-inset-top); }
      .face{ max-height: 78vh; }
    }

    /* ---- Drag/Swipe animation ---- */
    .face.dragging{ transition:none; will-change: transform, box-shadow; }
    .face.drag-right{ box-shadow:0 20px 40px rgba(46,204,113,.25); }
    .face.drag-left { box-shadow:0 20px 40px rgba(255,92,92,.25); }
    @keyframes swipeRight { to { transform: translateX(120%) rotate(12deg); opacity:.0; } }
    @keyframes swipeLeft  { to { transform: translateX(-120%) rotate(-12deg); opacity:.0; } }
    .swipe-right { animation: swipeRight .25s ease-out forwards; }
    .swipe-left  { animation: swipeLeft  .25s ease-out forwards; }

    /* ---- Stats popover ---- */
    #statsPopover{
      position: fixed; left: 12px; bottom: calc(12px + env(safe-area-inset-bottom));
      width: min(460px, 92vw); max-height: 55vh; overflow:auto;
      background:#0f1118; border:1px solid #1e2230; border-radius:14px;
      padding:12px 12px 14px; display:none; z-index: 20;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    #statsPopover h3{ margin:0 0 8px; font-size:15px; color:#cdd3da; }
    #statsPopover .meta{ font-size:12px; color:#9aa0a6; margin-bottom:8px; }
    #statsTable{ width:100%; border-collapse:collapse; font-size:14px; }
    #statsTable th, #statsTable td{ padding:8px 6px; border-bottom:1px solid #1e2230; }
    #statsTable th{ text-align:left; color:#9aa0a6; font-weight:600; }
    .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; }
    .b-good{ background:rgba(46,204,113,.15); color:var(--good); border:1px solid rgba(46,204,113,.3); }
    .b-learn{ background:rgba(255,92,92,.15); color:var(--bad); border:1px solid rgba(255,92,92,.3); }
    #closeStatsBtn{ margin-top:10px; font-size:12px; color:var(--accent); background:none; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Hanzi ‚Äî Audio Flashcards</h1>
      <div class="stats" id="stats">0 d√ªes ¬∑ 0 ma√Ætris√©es</div>
    </header>

    <div class="card" id="cardArea">
      <div class="face" id="face">
        <div class="front"><div class="hanzi" id="hanzi">Êàë</div></div>
        <div class="back">
          <div class="pinyin" id="pinyin">w«í</div>
          <div class="meaning" id="meaning">je / moi</div>
          <div class="pill" id="audioInfo">Audio</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn again" id="btnAgain">Encore</button>
      <button class="btn flip" id="btnFlip">Retourner</button>
      <button class="btn good" id="btnGood">OK</button>
      <button class="btn sound" id="btnSound">üîä √âcouter</button>
      <button class="btn tool" id="btnImport">Importer TSV</button>
    </div>

    <div class="deck-tools">
      <button class="link" id="reset">Remise √† z√©ro</button>
      <button class="link" id="exportJson">Exporter (JSON)</button>
    </div>
  </div>

  <!-- Stats popover -->
  <div id="statsPopover">
    <h3>Stats du deck</h3>
    <div class="meta" id="statsMeta">‚Äì</div>
    <div style="overflow:auto; max-height:45vh;">
      <table id="statsTable">
        <thead><tr><th>Hanzi</th><th>Pinyin</th><th>Statut</th><th>Vues</th></tr></thead>
        <tbody id="statsBody"></tbody>
      </table>
    </div>
    <button id="closeStatsBtn">Fermer</button>
  </div>

  <!-- Import TSV -->
  <dialog id="dlg">
    <div class="sheet">
      <strong>Importer un deck depuis TSV (Excel/Google Sheets)</strong>
      <div class="small">
        Colonnes : caract√®re ‚Äî pinyin ‚Äî traduction ‚Äî (optionnel) URL mp3.
        Si audio vide, l‚Äôapp cherche <code>./audios/&lt;HANZI&gt;.mp3</code>.<br>
        <em>Par d√©faut, l‚Äôimport FUSIONNE et conserve les stats. Coche ‚ÄúRemplacer tout (avanc√©)‚Äù pour reconstruire le deck depuis le TSV en r√©assignant les stats par cl√©.</em>
      </div>
      <textarea id="tsv"></textarea>
      <div class="row">
        <label class="small"><input type="checkbox" id="replaceAll"> Remplacer tout (avanc√©)</label>
        <div class="right">
          <button class="link" id="cancelDlg">Annuler</button>
          <button class="link" id="saveTsv">Importer</button>
        </div>
      </div>
      <div class="small" id="importSummary" style="display:none;"></div>
    </div>
  </dialog>

<script>
(function(){
  // ====== CONFIG ======
  const AUDIO_DIR = "./audios";
  const DEFAULT_TSV = `Êàë\tw«í\tje / moi\n‰Ω†\tn«ê\ttu / toi\n‰ªäÂ§©\tjƒ´ntiƒÅn\taujourd'hui`;
  const LS_KEY = "cn_flash_audio_tsv_v5"; // garde la m√™me cl√© pour compat

  const INTERVALS = [0, 60e3, 10*60e3, 60*60e3, 24*60*60e3, 3*24*60*60e3];

  // ====== Utils (cl√© stable & audio) ======
  function makeKey(h,p){ return (String(h||"").trim()+"|"+String(p||"").trim().toLowerCase()); }
  function guessAudioURL(h){ return `${AUDIO_DIR}/${encodeURIComponent(String(h).trim())}.mp3`; }

  // ====== TSV ======
  function parseTSV(tsv){
    const lines = (tsv||"").replace(/\r\n?/g,"\n").split("\n");
    const arr = [];
    for(const raw of lines){
      const line = raw.trim(); if(!line || line.startsWith("#")) continue;
      const cols = line.split(/\t+/); if(cols.length<3) continue;
      const [hanzi,pinyin,meaning,audio] = cols;
      const h = (hanzi||"").trim(), p=(pinyin||"").trim(), m=(meaning||"").trim(), a=(audio||"").trim();
      const key = makeKey(h,p);
      arr.push({key, hanzi:h, pinyin:p, meaning:m, audio:a});
    }
    return arr;
  }

  // ====== State ======
  let state = loadState();
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const obj = JSON.parse(raw);
        if(Array.isArray(obj.cards) && obj.cards.length){
          // r√©tro-compat : ajoute la cl√© si absente
          for(const c of obj.cards){
            if(!c.key) c.key = makeKey(c.hanzi, c.pinyin);
          }
          if(!obj.currentId && obj.cards[0]) obj.currentId = obj.cards[0].id || obj.cards[0].key;
          save(obj);
          return obj;
        }
      }
    }catch(e){}
    // init avec TSV par d√©faut
    const rows = parseTSV(DEFAULT_TSV);
    const cards = rows.map((c)=>({
      id: c.key, key:c.key, hanzi:c.hanzi, pinyin:c.pinyin, meaning:c.meaning,
      audio:c.audio||"", score:0,nextDue:0,seen:0,good:0,again:0
    }));
    shuffle(cards);
    const st = {cards, currentId: cards[0].id, flipped:false, createdAt: Date.now()};
    save(st); return st;
  }
  function save(o=state){ localStorage.setItem(LS_KEY, JSON.stringify(o)); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function now(){ return Date.now(); }
  function current(){ return state.cards.find(c=>c.id===state.currentId)||state.cards[0]; }

  function pickNext(){
    const due = state.cards.filter(c=>c.nextDue<=now());
    let next = null;
    if(due.length){ due.sort((a,b)=>a.score-b.score || a.seen-b.seen); next = due[0]; }
    else{ next = state.cards.slice().sort((a,b)=>a.nextDue-b.nextDue)[0]; }
    state.currentId = next.id; state.flipped = false; save(); render();
  }

  // ====== UI refs ======
  const face = document.getElementById('face');
  const hanziEl = document.getElementById('hanzi');
  const pinyinEl = document.getElementById('pinyin');
  const meaningEl = document.getElementById('meaning');
  const statsEl = document.getElementById('stats');
  const btnFlip = document.getElementById('btnFlip');
  const btnAgain = document.getElementById('btnAgain');
  const btnGood = document.getElementById('btnGood');
  const btnSound = document.getElementById('btnSound');
  const btnImport = document.getElementById('btnImport');
  const resetBtn = document.getElementById('reset');
  const exportBtn = document.getElementById('exportJson');
  const cardArea = document.getElementById('cardArea');
  const dlg = document.getElementById('dlg');
  const tsvTA = document.getElementById('tsv');
  const cancelDlgBtn = document.getElementById('cancelDlg');
  const saveTsvBtn = document.getElementById('saveTsv');
  const replaceAllCb = document.getElementById('replaceAll');
  const importSummaryEl = document.getElementById('importSummary');

  // ====== Audio ======
  const player = new Audio(); player.preload="none";
  async function playAudio(){
    const c = current(); if(!c) return;
    const url = (c.audio && c.audio.trim()) ? c.audio.trim() : guessAudioURL(c.hanzi);
    try{
      if(player.src !== url) player.src = url;
      await player.play(); return;
    }catch(e){ /* fallback synth√®se */ }
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance((c.hanzi||c.pinyin||"")+"");
      const voices = speechSynthesis.getVoices();
      const zh = voices.find(v => /zh-|chinese|han/i.test((v.lang||"")+(v.name||"")));
      if(zh) u.voice = zh; u.rate = .9; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
  }

  // ====== Render ======
  function render(){
    const c = current();
    hanziEl.textContent = c.hanzi||"";
    pinyinEl.textContent = c.pinyin||"";
    meaningEl.textContent = c.meaning||"";
    face.classList.toggle('flipped', state.flipped);
    const dueCount = state.cards.filter(x=>x.nextDue<=now()).length;
    const mastered = masteredCount();
    statsEl.textContent = `${dueCount} d√ªes ¬∑ ${mastered} ma√Ætris√©es`;
    resetFaceTransform();
  }

  function masteredCount(){
    const maxIdx = INTERVALS.length - 1;
    return state.cards.filter(c=>c.score>=maxIdx).length;
  }

  function flip(){ state.flipped=!state.flipped; save(); render(); }

  function answer(good){
    const c = current();
    c.seen++;
    if(good){ c.good++; c.score = Math.min(c.score+1, INTERVALS.length-1); c.nextDue = now()+INTERVALS[c.score]; }
    else    { c.again++; c.score = Math.max(0, c.score-1); c.nextDue = now()+30e3; }
    save();
    pickNext();
  }

  // ---- Desktop buttons ----
  btnFlip?.addEventListener('click', ()=>flip());
  btnGood?.addEventListener('click', ()=>answer(true));
  btnAgain?.addEventListener('click', ()=>answer(false));
  btnSound?.addEventListener('click', ()=>playAudio());
  btnImport?.addEventListener('click', ()=>{
    const tsv = state.cards.map(({hanzi,pinyin,meaning,audio})=>[hanzi,pinyin,meaning,audio||""].join("\t")).join("\n");
    tsvTA.value = tsv || DEFAULT_TSV;
    replaceAllCb.checked = false;
    importSummaryEl.style.display = 'none';
    importSummaryEl.textContent = "";
    dlg.showModal();
  });
  cancelDlgBtn?.addEventListener('click', ()=> dlg.close());

  // ====== Import (fusion par d√©faut + option remplacer tout) ======
  saveTsvBtn?.addEventListener('click', ()=>{
    try{
      const rows = parseTSV(tsvTA.value);
      if(!rows.length) throw new Error();

      const replaceAll = !!replaceAllCb.checked;

      // index existant par cl√©
      const byKey = new Map();
      for(const c of state.cards){ byKey.set(c.key || makeKey(c.hanzi,c.pinyin), c); }

      let added=0, updated=0, reassigned=0;

      if(replaceAll){
        const newCards = [];
        for(const r of rows){
          const old = byKey.get(r.key);
          if(old){
            // r√©assigner stats
            newCards.push({
              id: old.id, key:r.key, hanzi:r.hanzi, pinyin:r.pinyin, meaning:r.meaning,
              audio: r.audio || old.audio || "",
              score: old.score, nextDue: old.nextDue, seen: old.seen, good: old.good, again: old.again
            });
            reassigned++;
          }else{
            newCards.push({
              id: r.key, key:r.key, hanzi:r.hanzi, pinyin:r.pinyin, meaning:r.meaning,
              audio: r.audio || "", score:0,nextDue:0,seen:0,good:0,again:0
            });
            added++;
          }
        }
        // si currentId n'existe plus, pointe sur la premi√®re
        state.cards = newCards;
        if(!state.cards.find(c=>c.id===state.currentId) && state.cards[0]) state.currentId = state.cards[0].id;
        state.flipped = false;
        save();
      } else {
        // FUSION : maj si existe, sinon ajoute; on ne supprime rien
        for(const r of rows){
          const old = byKey.get(r.key);
          if(old){
            // met √† jour contenu sans toucher aux stats
            old.hanzi = r.hanzi; old.pinyin = r.pinyin; old.meaning = r.meaning;
            if(r.audio) old.audio = r.audio;
            updated++;
          } else {
            // nouvelle carte
            const nc = {
              id: r.key, key:r.key, hanzi:r.hanzi, pinyin:r.pinyin, meaning:r.meaning,
              audio: r.audio || "", score:0,nextDue:0,seen:0,good:0,again:0
            };
            state.cards.push(nc);
            added++;
          }
        }
        // l√©g√®re randomisation des toutes nouvelles pour le fun
        shuffle(state.cards);
        save();
      }

      // feedback
      importSummaryEl.textContent = `+${added} nouvelles ¬∑ ${updated} mises √† jour ¬∑ ${reassigned} r√©assign√©es`;
      importSummaryEl.style.display = 'block';

      dlg.close();
      render();
    }catch(e){
      alert("Format attendu : caract√®re\\tpinyin\\ttraduction[\\taudio]");
    }
  });

  resetBtn?.addEventListener('click', ()=>{
    if(confirm("Remise √† z√©ro ?")){
      localStorage.removeItem(LS_KEY); state = loadState(); render();
    }
  });

  exportBtn?.addEventListener('click', ()=>{
    const data = {
      deck: state.cards.map(({hanzi,pinyin,meaning,audio,score,nextDue,seen,good,again,key,id})=>({hanzi,pinyin,meaning,audio,score,nextDue,seen,good,again,key,id})),
      exportedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='flashcards-cn-audio.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // ===== Helpers reset transform =====
  function resetFaceTransform(){
    face.classList.remove('dragging','drag-right','drag-left','swipe-right','swipe-left');
    face.style.transform = '';
  }

  // ---- Interactions mobile (tap / long press -> audio|stats / swipe) ----
  face.addEventListener('click', ()=>{ if(!longPressFired) flip(); longPressFired=false; });

  let startX=null,startY=null, longPressTimer=null, longPressFired=false, longPressMode=null;

  function inBottomLeftCorner(x,y){
    const r = face.getBoundingClientRect();
    const withinLeft = (x - r.left) <= r.width * 0.35;
    const withinBottom = (r.bottom - y) <= r.height * 0.35;
    return withinLeft && withinBottom;
  }

  cardArea.addEventListener('touchstart', (e)=>{
    const t = e.changedTouches[0]; startX=t.clientX; startY=t.clientY;
    face.classList.add('dragging');
    longPressFired=false;
    longPressMode = inBottomLeftCorner(startX, startY) ? 'stats' : 'audio';
    longPressTimer = setTimeout(()=>{
      longPressFired = true;
      if(longPressMode==='stats'){ openStatsPopover(); }
      else{ playAudio(); }
    }, 500);
  }, {passive:true});

  cardArea.addEventListener('touchmove', (e)=>{
    if(startX===null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX, dy = t.clientY - startY;
    if(Math.abs(dx)>10 || Math.abs(dy)>10){ clearTimeout(longPressTimer); }
    if(Math.abs(dx) > Math.abs(dy)){
      const rot = dx/20;
      face.style.transform = `translateX(${dx}px) rotate(${rot}deg) ${state.flipped?'rotateY(180deg)':''}`;
      face.classList.toggle('drag-right', dx>0);
      face.classList.toggle('drag-left', dx<0);
    } else {
      face.classList.remove('drag-right','drag-left');
      face.style.transform = `${state.flipped?'rotateY(180deg)':''}`;
    }
  }, {passive:true});

  cardArea.addEventListener('touchend', (e)=>{
    clearTimeout(longPressTimer);
    if(startX===null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX, dy = t.clientY - startY;
    const absX = Math.abs(dx), absY = Math.abs(dy);
    const THX = 60;

    face.classList.remove('dragging','drag-right','drag-left');

    if(absX > absY && absX > THX){
      const cls = dx>0 ? 'swipe-right' : 'swipe-left';
      const good = dx>0;
      face.classList.add(cls);
      const onAnimEnd = ()=>{
        face.removeEventListener('animationend', onAnimEnd);
        resetFaceTransform();
        answer(good);
      };
      face.addEventListener('animationend', onAnimEnd);
    } else {
      resetFaceTransform();
    }
    startX=startY=null;
  }, {passive:true});

  // ====== Stats popover ======
  const statsPopover = document.getElementById('statsPopover');
  const statsMeta = document.getElementById('statsMeta');
  const statsBody = document.getElementById('statsBody');
  const closeStatsBtn = document.getElementById('closeStatsBtn');

  function openStatsPopover(){ buildStatsTable(); statsPopover.style.display = 'block'; }
  function closeStatsPopover(){ statsPopover.style.display = 'none'; }
  closeStatsBtn.addEventListener('click', closeStatsPopover);

  function buildStatsTable(){
    const maxIdx = INTERVALS.length - 1;
    const mastered = state.cards.filter(c=>c.score>=maxIdx).sort((a,b)=>a.hanzi.localeCompare(b.hanzi));
    const learning = state.cards.filter(c=>c.score<maxIdx).sort((a,b)=>a.hanzi.localeCompare(b.hanzi));
    statsMeta.textContent = `${mastered.length} ma√Ætris√©es ¬∑ ${learning.length} en cours ¬∑ ${state.cards.length} cartes`;
    const rows = [];
    for(const c of mastered){
      rows.push(`<tr><td>${escapeHTML(c.hanzi)}</td><td>${escapeHTML(c.pinyin||"")}</td><td><span class="badge b-good">Ma√Ætris√©e</span></td><td>${c.seen}</td></tr>`);
    }
    for(const c of learning){
      rows.push(`<tr><td>${escapeHTML(c.hanzi)}</td><td>${escapeHTML(c.pinyin||"")}</td><td><span class="badge b-learn">√Ä revoir</span></td><td>${c.seen}</td></tr>`);
    }
    statsBody.innerHTML = rows.join("");
  }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

  // Boot
  pickNext();
})();
</script>
</body>
</html>
