<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hanzi Flash ‚Äî Clean Mobile</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0f">
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
  }
  </script>

  <style>
    :root{--bg:#0b0b0f;--fg:#f3f3f5;--muted:#9aa0a6;--accent:#4f8cff;--good:#2ecc71;--bad:#ff5c5c;--card:#15151b;--card2:#1d1d26}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    .wrap{max-width:680px;margin:0 auto;padding:env(safe-area-inset-top) 16px calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;height:100%}

    header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;gap:8px}
    h1{font-size:16px;margin:0;color:var(--muted)}
    .stats{font-size:12px;color:var(--muted)}

    .card{flex:1;display:flex;align-items:center;justify-content:center;perspective:1000px;user-select:none;-webkit-user-select:none;touch-action:manipulation;margin:10px 0 14px}
    .face{
      width:100%;height:100%;max-height:62vh;border-radius:16px;
      background:linear-gradient(175deg,var(--card),var(--card2));
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;padding:24px;position:relative;
      transform-style:preserve-3d;transition:transform .38s ease;
    }
    .face.flipped{transform:rotateY(180deg)}
    .front,.back{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;backface-visibility:hidden;-webkit-backface-visibility:hidden;padding:24px}
    .back{transform:rotateY(180deg)}
    .hanzi{font-size:16vw;line-height:1;font-weight:600}
    @media (min-width:600px){.hanzi{font-size:96px}}
    .pinyin{font-size:6vw;opacity:.9}
    .meaning{font-size:5vw;color:var(--muted)}
    @media (min-width:600px){.pinyin{font-size:28px}.meaning{font-size:22px}}
    .hint{position:absolute;bottom:10px;left:0;right:0;text-align:center;color:var(--muted);font-size:12px}
    .pill{font-size:11px;color:#cbd1d8;background:#0c0e15;border:1px solid #2a2a33;border-radius:999px;padding:6px 10px}

    /* Controls (desktop) */
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{flex:1;border:none;border-radius:14px;padding:14px 16px;font-size:16px;font-weight:600;cursor:pointer}
    .again{background:rgba(255,92,92,.12);color:var(--bad);border:1px solid rgba(255,92,92,.3)}
    .flip{background:transparent;border:1px dashed #3a3a46;color:var(--muted);flex:0 0 auto}
    .good{background:rgba(46,204,113,.12);color:var(--good);border:1px solid rgba(46,204,113,.3)}
    .sound{background:transparent;border:1px solid #2a2a33;color:var(--fg);flex:0 0 auto}
    .tool{background:transparent;border:1px solid #2a2a33;color:var(--fg);flex:0 0 auto}
    .deck-tools{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .link{font-size:12px;color:var(--accent);background:none;border:none;padding:0;text-decoration:underline;cursor:pointer}

    dialog{border:none;border-radius:14px;background:#11131a;color:var(--fg);max-width:680px;width:92vw;padding:0}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .sheet{padding:16px;display:flex;flex-direction:column;gap:12px}
    textarea{width:100%;min-height:40vh;border-radius:10px;background:#0c0e15;color:var(--fg);border:1px solid #2a2a33;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .row{display:flex;gap:10px;justify-content:flex-end}
    .small{font-size:12px;color:var(--muted)}

    /* ---- Mobile √©pur√© : uniquement la carte visible ---- */
    @media (max-width:640px){
      header, .controls, .deck-tools{ display:none !important; }
      .wrap{ padding-top: env(safe-area-inset-top); }
      .face{ max-height: 78vh; }
    }

    /* ---- Drag/Swipe animation ---- */
    .face.dragging{
      transition:none;       /* pendant le drag, suivi direct du doigt */
      will-change: transform, box-shadow;
    }
    /* Couleur fant√¥me pendant le drag selon la direction */
    .face.drag-right{ box-shadow:0 20px 40px rgba(46,204,113,.25); }
    .face.drag-left { box-shadow:0 20px 40px rgba(255,92,92,.25); }

    @keyframes swipeRight {
      to { transform: translateX(120%) rotate(12deg); opacity:.0; }
    }
    @keyframes swipeLeft {
      to { transform: translateX(-120%) rotate(-12deg); opacity:.0; }
    }
    .swipe-right { animation: swipeRight .25s ease-out forwards; }
    .swipe-left  { animation: swipeLeft  .25s ease-out forwards; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Hanzi ‚Äî Audio Flashcards</h1>
      <div class="stats" id="stats">0 d√ªes ¬∑ 0 ma√Ætris√©es</div>
    </header>

    <div class="card" id="cardArea">
      <div class="face" id="face">
        <div class="front">
          <div class="hanzi" id="hanzi">Êàë</div>
          <div class="hint">tap = retourner ‚Ä¢ appui long = üîä ‚Ä¢ swipe ‚Üê/‚Üí</div>
        </div>
        <div class="back">
          <div class="pinyin" id="pinyin">w«í</div>
          <div class="meaning" id="meaning">je / moi</div>
          <div class="pill" id="audioInfo">Audio</div>
        </div>
      </div>
    </div>

    <!-- Contr√¥les desktop (cach√©s sur mobile) -->
    <div class="controls">
      <button class="btn again" id="btnAgain">Encore</button>
      <button class="btn flip" id="btnFlip">Retourner</button>
      <button class="btn good" id="btnGood">OK</button>
      <button class="btn sound" id="btnSound">üîä √âcouter</button>
      <button class="btn tool" id="btnImport">Importer TSV</button>
    </div>

    <div class="deck-tools">
      <button class="link" id="reset">Remise √† z√©ro</button>
      <button class="link" id="exportJson">Exporter (JSON)</button>
    </div>
  </div>

  <!-- Import TSV -->
  <dialog id="dlg">
    <div class="sheet">
      <strong>Importer un deck depuis TSV (Excel/Google Sheets)</strong>
      <div class="small">Colonnes : caract√®re ‚Äî pinyin ‚Äî traduction ‚Äî (optionnel) URL mp3. Si vide, l‚Äôapp cherche <code>./audios/&lt;HANZI&gt;.mp3</code>.</div>
      <textarea id="tsv"></textarea>
      <div class="row">
        <button class="link" id="cancelDlg">Annuler</button>
        <button class="link" id="saveTsv">Importer</button>
      </div>
    </div>
  </dialog>

<script>
(function(){
  // ====== CONFIG ======
  const AUDIO_DIR = "./audios";
  const DEFAULT_TSV = `Êàë\tw«í\tje / moi\n‰Ω†\tn«ê\ttu / toi\n‰ªäÂ§©\tjƒ´ntiƒÅn\taujourd'hui`;

  function guessAudioURL(h){ return `${AUDIO_DIR}/${encodeURIComponent(String(h).trim())}.mp3`; }

  function parseTSV(tsv){
    const lines = (tsv||"").replace(/\r\n?/g,"\n").split("\n");
    const arr = [];
    for(const raw of lines){
      const line = raw.trim(); if(!line || line.startsWith("#")) continue;
      const cols = line.split(/\t+/); if(cols.length<3) continue;
      const [hanzi,pinyin,meaning,audio] = cols;
      arr.push({hanzi:hanzi.trim(),pinyin:(pinyin||"").trim(),meaning:(meaning||"").trim(),audio:(audio||"").trim()});
    }
    return arr;
  }

  // ====== SRS ======
  const INTERVALS = [0, 60e3, 10*60e3, 60*60e3, 24*60*60e3, 3*24*60*60e3];
  const LS_KEY = "cn_flash_audio_tsv_v3";

  let state = loadState();
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){ const obj=JSON.parse(raw); if(Array.isArray(obj.cards)&&obj.cards.length) return obj; }
    }catch(e){}
    const rows = parseTSV(DEFAULT_TSV);
    const cards = rows.map((c,i)=>({id:i+"_"+c.hanzi, ...c, score:0,nextDue:0,seen:0,good:0,again:0}));
    if(!cards.length){ cards.push({id:"0_Êàë",hanzi:"Êàë",pinyin:"w«í",meaning:"je / moi",audio:"",score:0,nextDue:0,seen:0,good:0,again:0}); }
    shuffle(cards);
    const st = {cards, currentId: cards[0].id, flipped:false, createdAt: Date.now()};
    save(st); return st;
  }
  function save(o=state){ localStorage.setItem(LS_KEY, JSON.stringify(o)); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function now(){ return Date.now(); }
  function current(){ return state.cards.find(c=>c.id===state.currentId)||state.cards[0]; }

  function pickNext(){
    const due = state.cards.filter(c=>c.nextDue<=now());
    let next = null;
    if(due.length){ due.sort((a,b)=>a.score-b.score || a.seen-b.seen); next = due[0]; }
    else{ next = state.cards.slice().sort((a,b)=>a.nextDue-b.nextDue)[0]; }
    state.currentId = next.id; state.flipped = false; save(); render();
  }

  // ====== UI refs ======
  const face = document.getElementById('face');
  const hanziEl = document.getElementById('hanzi');
  const pinyinEl = document.getElementById('pinyin');
  const meaningEl = document.getElementById('meaning');
  const statsEl = document.getElementById('stats');
  const btnFlip = document.getElementById('btnFlip');
  const btnAgain = document.getElementById('btnAgain');
  const btnGood = document.getElementById('btnGood');
  const btnSound = document.getElementById('btnSound');
  const btnImport = document.getElementById('btnImport');
  const resetBtn = document.getElementById('reset');
  const exportBtn = document.getElementById('exportJson');
  const cardArea = document.getElementById('cardArea');
  const dlg = document.getElementById('dlg');
  const tsvTA = document.getElementById('tsv');
  const cancelDlgBtn = document.getElementById('cancelDlg');
  const saveTsvBtn = document.getElementById('saveTsv');

  // ====== Audio + fallback ======
  const player = new Audio(); player.preload="none";
  async function playAudio(){
    const c = current(); if(!c) return;
    const url = (c.audio && c.audio.trim()) ? c.audio.trim() : guessAudioURL(c.hanzi);
    try{
      if(player.src !== url) player.src = url;
      await player.play(); return;
    }catch(e){ console.warn("Audio KO, fallback synth√®se", e); }
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance((c.hanzi||c.pinyin||"")+"");
      const voices = speechSynthesis.getVoices();
      const zh = voices.find(v => /zh-|chinese|han/i.test((v.lang||"")+(v.name||"")));
      if(zh) u.voice = zh; u.rate = .9; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
  }

  // ====== Render ======
  function render(){
    const c = current();
    hanziEl.textContent = c.hanzi||"";
    pinyinEl.textContent = c.pinyin||"";
    meaningEl.textContent = c.meaning||"";
    face.classList.toggle('flipped', state.flipped);
    const dueCount = state.cards.filter(x=>x.nextDue<=now()).length;
    const mastered = state.cards.filter(x=>x.score>=INTERVALS.length-1).length;
    statsEl.textContent = `${dueCount} d√ªes ¬∑ ${mastered} ma√Ætris√©es`;
  }

  function flip(){ state.flipped=!state.flipped; save(); render(); }
  function answer(good){
    const c = current();
    c.seen++;
    if(good){ c.good++; c.score = Math.min(c.score+1, INTERVALS.length-1); c.nextDue = now()+INTERVALS[c.score]; }
    else    { c.again++; c.score = Math.max(0, c.score-1); c.nextDue = now()+30e3; }
    save(); pickNext();
  }

  // ---- Desktop buttons (cach√©s sur mobile) ----
  btnFlip.addEventListener('click', ()=>flip());
  btnGood.addEventListener('click', ()=>answer(true));
  btnAgain.addEventListener('click', ()=>answer(false));
  btnSound.addEventListener('click', ()=>playAudio());
  btnImport.addEventListener('click', ()=>{
    const tsv = state.cards.map(({hanzi,pinyin,meaning,audio})=>[hanzi,pinyin,meaning,audio||""].join("\t")).join("\n");
    tsvTA.value = tsv || DEFAULT_TSV; dlg.showModal();
  });
  cancelDlgBtn.addEventListener('click', ()=> dlg.close());
  saveTsvBtn.addEventListener('click', ()=>{
    try{
      const rows = parseTSV(tsvTA.value); if(!rows.length) throw new Error();
      const cards = rows.map((c,i)=>({id:i+"_"+(c.hanzi||("id"+i)), ...c, score:0,nextDue:0,seen:0,good:0,again:0}));
      shuffle(cards);
      state = {cards, currentId: cards[0].id, flipped:false, createdAt: Date.now()};
      save(); dlg.close(); render();
    }catch(e){ alert("Format: caract√®re\\tpinyin\\ttraduction[\\taudio]"); }
  });
  resetBtn.addEventListener('click', ()=>{
    if(confirm("Remise √† z√©ro ?")){
      localStorage.removeItem(LS_KEY); state = loadState(); render();
    }
  });
  exportBtn.addEventListener('click', ()=>{
    const data = {
      deck: state.cards.map(({hanzi,pinyin,meaning,audio,score,nextDue,seen,good,again})=>({hanzi,pinyin,meaning,audio,score,nextDue,seen,good,again})),
      exportedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='flashcards-cn-audio.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // ---- Interactions mobile : tap / appui long / swipe anim√© ----
  face.addEventListener('click', ()=>{ if(!longPressFired) flip(); longPressFired=false; });

  let startX=null,startY=null, dragging=false, longPressTimer=null, longPressFired=false;

  cardArea.addEventListener('touchstart', (e)=>{
    const t = e.changedTouches[0]; startX=t.clientX; startY=t.clientY;
    dragging=true; face.classList.add('dragging');
    longPressFired=false;
    longPressTimer = setTimeout(()=>{ longPressFired=true; playAudio(); }, 500); // appui long = audio
  }, {passive:true});

  cardArea.addEventListener('touchmove', (e)=>{
    if(startX===null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX, dy = t.clientY - startY;
    if(Math.abs(dx)>10 || Math.abs(dy)>10){ clearTimeout(longPressTimer); }
    // on suit le doigt (rotation l√©g√®re)
    const rot = dx/20;
    face.style.transform = `translateX(${dx}px) rotate(${rot}deg) ${state.flipped?'rotateY(180deg)':''}`;
    face.classList.toggle('drag-right', dx>0);
    face.classList.toggle('drag-left', dx<0);
  }, {passive:true});

  cardArea.addEventListener('touchend', (e)=>{
    clearTimeout(longPressTimer);
    if(startX===null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX, dy = t.clientY - startY;
    const horizontal = Math.abs(dx) > Math.abs(dy);
    const TH = 60; // seuil

    face.classList.remove('dragging','drag-right','drag-left');
    face.style.transform = ''; // reset

    if(horizontal && Math.abs(dx) > TH){
      // swipe: anime puis note la r√©ponse
      const cls = dx>0 ? 'swipe-right' : 'swipe-left';
      face.classList.add(cls);
      const good = dx>0;
      face.addEventListener('animationend', function handler(){
        face.classList.remove(cls);
        face.removeEventListener('animationend', handler);
        answer(good);
      });
    } else {
      // pas assez : rien (le tap simple d√©clenchera flip via click)
    }
    startX=startY=null; dragging=false;
  }, {passive:true});

  // Boot
  pickNext();
})();
</script>
</body>
</html>
